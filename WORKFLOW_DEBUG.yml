name: Build iOS .ipa (Debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Debug - Show environment
      run: |
        echo "üîç Xcode versiyonu:"
        xcodebuild -version
        echo ""
        echo "üîç Swift versiyonu:"
        swift --version
        echo ""
        echo "üîç Mevcut dizin:"
        pwd
        echo ""
        echo "üîç Dosya yapƒ±sƒ±:"
        ls -la
    
    - name: Debug - Check Xcode project
      run: |
        if [ -d "Sessiz.xcodeproj" ]; then
          echo "‚úÖ Xcode projesi bulundu"
          echo "üìã Proje i√ßeriƒüi:"
          ls -la Sessiz.xcodeproj/
        else
          echo "‚ùå Xcode projesi bulunamadƒ±!"
          echo "üìÅ Mevcut dosyalar:"
          find . -name "*.xcodeproj" -o -name "*.xcworkspace" | head -10
          exit 1
        fi
    
    - name: Debug - List schemes
      run: |
        echo "üìã Scheme'ler:"
        xcodebuild -list -project Sessiz.xcodeproj 2>&1 || {
          echo "‚ùå Scheme listesi alƒ±namadƒ±, alternatif y√∂ntem:"
          xcodebuild -list 2>&1 || true
        }
    
    - name: Debug - Check Swift files
      run: |
        echo "üìÑ Swift dosyalarƒ±:"
        find . -name "*.swift" -type f | head -10
        echo ""
        echo "üìÑ Info.plist:"
        ls -la Info.plist || echo "Info.plist bulunamadƒ±"
    
    - name: Build Archive (with detailed output)
      run: |
        set -x  # Debug mode
        xcodebuild clean archive \
          -project Sessiz.xcodeproj \
          -scheme Sessiz \
          -configuration Release \
          -archivePath ./build/Sessiz.xcarchive \
          -destination "generic/platform=iOS" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee build.log
        BUILD_STATUS=${PIPESTATUS[0]}
        if [ $BUILD_STATUS -ne 0 ]; then
          echo "‚ùå Build ba≈üarƒ±sƒ±z! Exit code: $BUILD_STATUS"
          echo "üìã Son 50 satƒ±r:"
          tail -50 build.log
          exit $BUILD_STATUS
        fi
    
    - name: Create Export Options
      if: success()
      run: |
        mkdir -p build
        cat > build/ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
        </dict>
        </plist>
        EOF
    
    - name: Export IPA
      if: success()
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/Sessiz.xcarchive \
          -exportPath ./build/export \
          -exportOptionsPlist ./build/ExportOptions.plist \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | tee export.log
        EXPORT_STATUS=${PIPESTATUS[0]}
        if [ $EXPORT_STATUS -ne 0 ]; then
          echo "‚ùå Export ba≈üarƒ±sƒ±z! Exit code: $EXPORT_STATUS"
          echo "üìã Son 50 satƒ±r:"
          tail -50 export.log
          exit $EXPORT_STATUS
        fi
    
    - name: Find and Upload IPA
      if: success()
      run: |
        IPA_FILE=$(find ./build/export -name "*.ipa" 2>/dev/null | head -1)
        if [ -z "$IPA_FILE" ]; then
          echo "‚ùå IPA dosyasƒ± bulunamadƒ±!"
          echo "üìÅ Export klas√∂r√º:"
          ls -la ./build/export/ || echo "Klas√∂r yok"
          exit 1
        fi
        echo "‚úÖ IPA bulundu: $IPA_FILE"
        ls -lh "$IPA_FILE"
    
    - name: Upload IPA artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Sessiz.ipa
        path: build/export/*.ipa
        retention-days: 30

